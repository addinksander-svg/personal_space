<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Workout Planner (Performance Interface)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Neon-like title for futuristic look */
        .futuristic-title {
            color: #22d3ee; /* cyan-400 */
            text-shadow: 0 0 8px rgba(34, 211, 238, 0.5), 0 0 15px rgba(34, 211, 238, 0.2);
        }

        /* Custom checkbox style - applies to the DIV inside the label */
        .muscle-label > div {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            /* Default state styling: Slate-800 */
            background-color: #1e293b;
            border-color: #334155;
        }

        /* Hover state for enabled boxes */
        .muscle-label:not(.disabled-state) > div:hover {
            background-color: #334155; /* slate-700 */
        }

        /* Checked state for manual selection: Cyan-400 */
        .muscle-label input:checked + div:not(.disabled-state) {
            background-color: #22d3ee;
            color: #0f172a; /* Slate-950 text */
            border-color: #22d3ee;
        }

        /* Visually hide checkbox input */
        .muscle-label input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 1px;
            height: 1px;
        }

        /* Custom list style for Do's/Don'ts */
        #form-checklist ul {
            list-style: disc;
            padding-left: 1.5rem;
            color: #94a3b8; /* Slate-400 */
        }

        #form-checklist li {
            margin-bottom: 0.5rem;
        }

        /* Custom styling for the range slider */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #22d3ee; /* Cyan-400 */
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.4);
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #22d3ee; /* Cyan-400 */
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.4);
        }

        /* Styling for the disabled, but selected/locked PPL groups */
        .muscle-label.disabled-state input:checked + div {
            background-color: #06b6d4; /* Darker Cyan */
            border-color: #06b6d4;
            color: #0f172a;
        }

        /* Styling for the disabled, unselected PPL groups (dashed border) */
        .muscle-label.disabled-state input:not(:checked) + div {
            background-color: #0f172a; /* Slate-950, blending into card */
            border-style: dashed;
            border-color: #334155; /* Slate-700 */
            color: #475569; /* Slate-600 */
            cursor: not-allowed;
            pointer-events: none;
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .animate-futuristic-gradient {
            animation: gradient-shift 15s ease infinite;
        }

        @keyframes pattern-scroll {
            to {
                background-position: 40px 40px;
            }
        }

        .animate-pattern-move {
            animation: pattern-scroll 10s linear infinite;
        }

        body::-webkit-scrollbar {
            display: none; 
        }

        body {
            -ms-overflow-style: none;
        }

        html {
            scrollbar-width: none; 
        }
    </style>
</head>
<body class="relative w-full bg-gradient-to-r from-slate-900 via-indigo-900 to-cyan-900 bg-[length:400%_400%] animate-futuristic-gradient text-gray-100">
    <div class="absolute inset-0 z-0 opacity-20 bg-repeat bg-[size:40px_40px] animate-pattern-move" style="background-image: radial-gradient(circle, #22d3ee 1px, transparent 1px);"></div>
    <div class="relative z-10 container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-10" id="main-header">
            <!-- Updated Title: Simple and direct -->
            <h1 class="text-3xl md:text-4xl font-extrabold futuristic-title">DYNAMIC WORKOUT PLANNER</h1>
            <p class="text-gray-400 mt-2 text-sm md:text-base tracking-widest uppercase">Build your next custom training session.</p>
        </header>

        <!-- Workout Generator/Input Card -->
        <div id="generator-card" class="bg-slate-900 p-6 rounded-xl shadow-2xl mb-8 border border-slate-800">
            <!-- Updated Heading: Less technical -->
            <h2 class="text-xl font-semibold mb-5 text-cyan-400 border-b border-slate-700 pb-2">WORKOUT SETTINGS</h2>

            <!-- Duration Selector -->
            <h3 class="text-lg font-semibold mb-2 text-gray-50">1. Select Duration: <span id="duration-display" class="font-bold text-cyan-400">45 Minutes</span></h3>
            <div class="mb-6">
                <input type="range" id="workout-duration" min="15" max="120" step="5" value="45" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <span>15 Mins</span>
                    <span>120 Mins (2 Hrs)</span>
                </div>
            </div>

            <!-- Workout Type Selector -->
            <h3 class="text-lg font-semibold mb-2 text-gray-50">2. Select Training Focus</h3>
            <select id="workout-type" class="w-full p-3 mb-6 bg-slate-800 border border-slate-700 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 text-gray-200">
                <option value="Hypertrophy" selected>Muscle Growth (Hypertrophy)</option>
                <option value="Strength">Maximal Strength & Power</option>
                <option value="HIIT">High-Intensity Interval Training (HIIT)</option>
            </select>

            <!-- Muscle Selection Section -->
            <h3 class="text-lg font-semibold mb-2 text-gray-50">3. Select Target Muscle Groups</h3>

            <!-- PPL Quick Select -->
            <div class="mb-4">
                <!-- Updated label: Less technical -->
                <label for="ppl-selector" class="text-sm font-medium text-slate-400 block mb-1">Quick Select (Push-Pull-Legs Days)</label>
                <select id="ppl-selector" class="w-full p-3 mb-2 bg-slate-800 border border-slate-700 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 text-gray-200">
                    <option value="None" selected>— Manual Targeting —</option>
                    <option value="Push">Push Day</option>
                    <option value="Pull">Pull Day</option>
                    <option value="Legs">Leg Day</option>
                </select>
            </div>

            <!-- Core Toggle for Quick Select -->
            <div id="ppl-core-toggle-container" class="hidden mb-6">
                <label for="ppl-include-core" class="flex items-center space-x-2 cursor-pointer text-gray-200 hover:text-cyan-400 transition-colors">
                    <input type="checkbox" id="ppl-include-core" class="form-checkbox h-5 w-5 text-cyan-500 rounded border-slate-700 bg-slate-800 focus:ring-cyan-500 transition duration-150 ease-in-out">
                    <!-- Updated text: Less technical -->
                    <span class="font-medium">Include Core</span>
                </label>
            </div>

            <!-- Muscle Group Selector (Manual Checkboxes) -->
            <label class="text-sm font-medium text-slate-400 block mb-2">Manual Muscle Group Selection</label>
            <div id="muscle-group-selector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-6">
                <!-- Muscle group checkboxes will be injected here by JS -->
            </div>

            <!-- Updated Button Text: Simple and direct -->
            <button id="generate-btn" class="w-full bg-cyan-600 text-slate-950 font-extrabold py-3 px-5 rounded-lg hover:bg-cyan-500 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 focus:ring-offset-slate-900 flex items-center justify-center shadow-lg shadow-cyan-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2 1M4 7l2-1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1m2 1l-2 1m2-1V16a2.5 2.5 0 015 0v2.5m0 0l2 1m-2-1l2-1m-2 1v2.5m-5-10.5l2-1m-2 1l2 1m-2 1V6a2.5 2.5 0 015 0v2.5m0 0l-2-1m2 1l-2 1m2-1V11" />
                </svg>
                BUILD MY WORKOUT
            </button>
        </div>

        <!-- Main content area for generated workout -->
        <main id="workout-content">
            <section id="generated-workout-content">
                <div id="workout-placeholder" class="text-center text-slate-400 bg-slate-900 p-10 rounded-xl shadow-md border border-slate-800">
                    <p class="text-lg">Workout plan pending generation...</p>
                    <p class="text-sm">Configure your settings above and click the 'Build My Workout' button.</p>
                </div>

                <div id="workout-loader" class="hidden text-center text-cyan-400 bg-slate-900 p-10 rounded-xl shadow-md border border-slate-800">
                    <div class="flex justify-center items-center">
                        <div class="w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mr-3"></div>
                        <!-- Updated Loading Message: Less technical -->
                        <p class="text-lg font-semibold">Building Optimal Workout...</p>
                    </div>
                </div>

                <!-- Initial List View (before starting roadmap) -->
                <div id="workout-list" class="space-y-4">
                    <!-- Generated exercise summaries and Start Button will be injected here by JS -->
                </div>
            </section>

            <!-- START: New Roadmap View (hidden by default) -->
            <div id="workout-roadmap" class="hidden">
                <!-- Updated Heading: Less technical -->
                <h2 class="text-3xl font-bold mb-6 futuristic-title text-center">ACTIVE WORKOUT SESSION</h2>

                <!-- 1. History (Completed/Skipped) -->
                <div id="history-list" class="space-y-3 mb-8">
                    <!-- History items injected here -->
                </div>

                <!-- 2. Current Exercise Card (BIG CARD) -->
                <div id="current-exercise-display" class="bg-slate-900 p-6 rounded-xl shadow-2xl mb-8 border-4 border-cyan-500">
                    <!-- Content injected here -->
                </div>

                <!-- 3. Navigation (Skip/Done Buttons) -->
                <div class="flex justify-between space-x-4 mb-8">
                    <!-- Updated Button Text: Less technical -->
                    <button id="skip-btn" class="w-full bg-amber-500 text-slate-950 font-bold py-3 px-5 rounded-lg hover:bg-amber-400 transition-colors duration-300 ring-2 ring-amber-500 focus:outline-none focus:ring-offset-2 focus:ring-amber-500 focus:ring-offset-slate-950 shadow-lg shadow-amber-500/30">
                        Skip Exercise
                    </button>
                    <!-- Updated Button Text: Less technical -->
                    <button id="done-btn" class="w-full bg-emerald-500 text-slate-950 font-bold py-3 px-5 rounded-lg hover:bg-emerald-400 transition-colors duration-300 ring-2 ring-emerald-500 focus:outline-none focus:ring-offset-2 focus:ring-emerald-500 focus:ring-offset-slate-950 shadow-lg shadow-emerald-500/30">
                        Completed & Next
                    </button>
                </div>

                <!-- 4. Upcoming Exercises -->
                <div id="upcoming-list" class="space-y-3 mb-6 border-t border-slate-800 pt-4">
                    <!-- Updated Heading: Less technical -->
                    <h3 class="text-lg font-semibold text-slate-400 mb-2 border-b border-slate-800 pb-1 uppercase tracking-wider">Next Exercises</h3>
                </div>
            </div>
            <!-- END: New Roadmap View -->

        </main>
    </div>

    <script>
        // *** IMPORTANT: API Key is set to an empty string ***
        const API_KEY = "AIzaSyDunX46S7Y6evdIhkatwD0FsZoEHS_WUqU"
        const MAX_RETRIES = 5;

        // Global State for the Active Workout
        let currentWorkout = [];
        let currentExerciseIndex = 0;

        // YouTube search filter for 4-20 minute videos
        const YOUTUBE_DURATION_FILTER = '&sp=EgQQARgB';

        // Data structure for workout types and their rest time guidance (in seconds)
        const workoutPresets = {
            Hypertrophy: { minEx: 5, maxEx: 7, restTarget: "90 seconds", restDesc: "to create metabolic stress." },
            Strength: { minEx: 2, maxEx: 4, restTarget: "180 seconds (3 minutes)", restDesc: "to ensure max recovery and performance." },
            HIIT: { minEx: 4, maxEx: 5, restTarget: "30 seconds", restDesc: "or a work-to-rest ratio." }
        };

        // List of muscle groups for the checkboxes (Gabs removed)
        const muscleGroups = [
            'Chest', 'Back', 'Quads', 'Hamstrings', 'Glutes', 'Shoulders',
            'Biceps', 'Triceps', 'Core', 'Calves'
        ];

        // PPL MAPPING
        const pplMap = {
            'None': [],
            'Push': ['Chest', 'Shoulders', 'Triceps'],
            'Pull': ['Back', 'Biceps'],
            'Legs': ['Quads', 'Hamstrings', 'Glutes', 'Calves'],
        };

        // Helper function to format the raw tip string into HTML lists (UL/LI)
        function formatTipsToHtml(rawTipsText) {
            if (!rawTipsText) return `<p class="text-slate-400 italic">No detailed focus points available yet.</p>`;

            // Split the raw text using the unique separator defined in the prompt
            const parts = rawTipsText.split('---SEPARATOR---');
            if (parts.length !== 2) {
                // Fallback for unexpected format
                return `<p class="text-red-400">Error parsing focus points content. Please try skipping and re-generating the cues.</p>`;
            }

            const doListText = parts[0].trim();
            const dontListText = parts[1].trim();

            // Helper to convert raw bullet points (* text) into HTML list
            const listToHtml = (listText) => {
                if (listText.length === 0) return '<ul><li>No points provided.</li></ul>';

                // Split by new line, filter out empty lines, and map to <li> tags
                return `<ul>${listText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.startsWith('*') || line.startsWith('-')) // Only keep bullet points
                    .map(line => `<li>${line.substring(1).trim()}</li>`) // Remove the leading * or -
                    .join('')}</ul>`;
            };

            return `
                        <div class="space-y-4">
                            <!-- Updated Headers: Less technical -->
                            <h4 class="text-xl font-bold text-emerald-400">Proper Technique (Do)</h4>
                            ${listToHtml(doListText)}

                            <h4 class="text-xl font-bold text-red-400">Common Mistakes (Don't)</h4>
                            ${listToHtml(dontListText)}
                        </div>
                    `;
        }

        // Helper function to generate the YouTube search link HTML
        function createVideoLinkHtml(exerciseName) {
            const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(exerciseName + " exercise tutorial")}`;
            const finalUrl = searchUrl + YOUTUBE_DURATION_FILTER;

            // Updated text: Less technical, more direct
            return `
                        <a href="${finalUrl}" target="_blank" class="inline-flex items-center text-sm font-medium
                            text-cyan-400 hover:text-cyan-300 transition-colors duration-200 border-b border-dashed border-cyan-500/50">
                            <!-- Generic Video Camera Icon SVG (Lucide-inspired) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1">
                                <path d="M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8l-5-5z"/>
                                <path d="M15 3v4a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V3"/>
                                <path d="M12 12v4"/>
                            </svg>
                            View Form Tutorial
                        </a>
                    `;
        }

        // Helper to parse the focus string (e.g., "Chest (Pecs, Delts)") into structured data
        function parseFocusDisplay(focusString) {
            const match = focusString.match(/^([^ (]+)\s*(?:\((.*)\))?$/);
            if (!match) return { mainGroup: focusString, specifics: [] };

            const mainGroup = match[1].trim();
            const specificMusclesString = match[2] || '';
            const specifics = specificMusclesString.split(',').map(s => s.trim()).filter(s => s.length > 0);

            return { mainGroup, specifics };
        }

        // Helper to render the target area in the two-line style (Main Group + Tags below)
        function renderTargetAreaTwoLine(focusString) {
            const { mainGroup, specifics } = parseFocusDisplay(focusString);

            // 1. Build the main line (Target Area: Main Group)
            let mainTargetLine = `<p class="text-lg font-bold text-cyan-400">${mainGroup}</p>`;

            // 2. Build the tags line (Tags below, centered)
            let tagsLine = '';
            if (specifics.length > 0) {
                // Use a flex container for the tags
                tagsLine = `<div class="flex flex-wrap justify-center gap-x-1 gap-y-1 mt-1">`;
                specifics.forEach(muscle => {
                    // Small text, deep dark background, and a light blue outline/text
                    tagsLine += `<span class="text-xs font-medium px-1.5 py-0.5 rounded-full bg-slate-800 text-cyan-300 border border-slate-700">${muscle}</span>`;
                });
                tagsLine += `</div>`;
            }

            return mainTargetLine + tagsLine;
        }


        // Renders the detailed card for the initial generated list (Planner View)
        function createInitialListCard(exercise, index) {
            const videoLinkHtml = createVideoLinkHtml(exercise.name);

            // 1. Use the parser to get structured data
            const { mainGroup, specifics } = parseFocusDisplay(exercise.focus);

            // 2. Build the main line (Target Area: Label + Main Group)
            let mainTargetLine = `<p class="text-md text-slate-200">
                                            <span class="font-semibold text-slate-400">Primary Focus:</span>
                                            ${mainGroup}
                                          </p>`;

            // 3. Build the tags line (Tags below, slightly indented)
            let tagsLine = '';
            if (specifics.length > 0) {
                tagsLine = `<div class="flex flex-wrap gap-x-2 gap-y-1 ml-4 mt-1">`;
                specifics.forEach(muscle => {
                    tagsLine += `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-slate-700 text-slate-200">${muscle}</span>`;
                });
                tagsLine += `</div>`;
            }


            return `
                        <div class="bg-slate-900 p-5 rounded-xl shadow-lg border border-slate-800">
                            <h3 class="text-xl font-bold text-cyan-400 mb-3">${index + 1}. ${exercise.name}</h3>

                            <!-- Structured Metrics Display (Stacked) -->
                            <div class="space-y-2 mb-4">

                                <!-- Target Area Block (Two Lines: Label/Main Group + Tags) -->
                                <div>
                                    ${mainTargetLine}
                                    ${tagsLine}
                                </div>

                                <p class="text-md text-slate-200"><span class="font-semibold text-slate-400">Sets/Reps:</span> ${exercise.setsReps}</p>
                                <p class="text-md text-slate-200"><span class="font-semibold text-slate-400">Rest Between Sets:</span> ${exercise.restTime}</p>
                            </div>

                            <!-- Short Explanation -->
                            <div class="bg-slate-800 p-3 rounded-lg mb-4 border border-slate-700">
                                <!-- Updated label: Less technical -->
                                <p class="text-sm text-slate-400 font-semibold mb-1">Exercise Description:</p>
                                <p class="text-slate-200">${exercise.description}</p>
                            </div>

                            <!-- Video Link -->
                            <div class="flex justify-start mt-3">
                                ${videoLinkHtml}
                            </div>
                        </div>
                    `;
        }

        // Renders the large card for the current exercise in the Roadmap View - WITH TIPS
        function createRoadmapCard(exercise) {

            // Define tip content/loading message
            let tipsContent;
            if (exercise.tips) {
                // If tips are fetched, format them into HTML
                tipsContent = formatTipsToHtml(exercise.tips);
            } else if (exercise.isFetchingTips) {
                // Show loading spinner
                // Updated Loading Text
                tipsContent = `
                            <div class="flex justify-center items-center text-cyan-400">
                                <div class="w-6 h-6 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mr-3"></div>
                                <p>Accessing detailed form focus points...</p>
                            </div>
                        `;
            } else {
                // Failed or pending fetch
                tipsContent = `<p class="text-red-400">Form focus points access denied (API error).</p>`;
            }

            // Create YouTube link using the helper function
            const videoLinkHtml = createVideoLinkHtml(exercise.name);

            return `
                        <div class="text-center">
                            <!-- Updated Step Counter: Less technical -->
                            <p class="text-sm font-mono text-cyan-300 uppercase tracking-widest">EXERCISE ${currentExerciseIndex + 1} / ${currentWorkout.length}</p>

                            <h3 class="text-3xl font-extrabold futuristic-title mt-1 mb-4">${exercise.name}</h3>

                            <!-- Video Link -->
                            <div class="mb-6 flex justify-center">
                                ${videoLinkHtml}
                            </div>
                        </div>

                        <!-- Structured Display of Metrics -->
                        <div class="grid grid-cols-3 gap-4 text-center mb-8">
                            <div class="bg-slate-950 p-3 rounded-lg border-b-4 border-cyan-500 text-center shadow-lg shadow-cyan-500/10">
                                <p class="text-xs text-slate-400 font-medium">PRIMARY FOCUS</p>
                                <div class="mt-1">
                                    ${renderTargetAreaTwoLine(exercise.focus)}
                                </div>
                            </div>
                            <div class="bg-slate-950 p-3 rounded-lg border-b-4 border-cyan-500 shadow-lg shadow-cyan-500/10">
                                <p class="text-xs text-slate-400 font-medium">VOLUME / INTENSITY</p>
                                <p class="text-lg font-bold text-gray-100">${exercise.setsReps}</p>
                            </div>
                            <div class="bg-slate-950 p-3 rounded-lg border-b-4 border-cyan-500 shadow-lg shadow-cyan-500/10">
                                <p class="text-xs text-slate-400 font-medium">RECOVERY TIME</p>
                                <p class="text-lg font-bold text-gray-100">${exercise.restTime}</p>
                            </div>
                        </div>

                        <!-- Short Explanation -->
                        <div class="bg-slate-800 p-5 rounded-xl shadow-inner mt-4 mb-4 border border-slate-700">
                            <!-- Updated Header: Less technical -->
                            <h4 class="text-xl font-semibold mb-2 text-cyan-400 border-b border-slate-700 pb-1">Exercise Goal</h4>
                            <p class="text-slate-200">${exercise.description}</p>
                        </div>

                        <!-- Detailed Form Checklist Section (Tips Content) -->
                        <div id="form-checklist" class="bg-slate-800 p-5 rounded-xl shadow-inner mt-4 border border-slate-700">
                            <!-- Updated Heading: Less technical -->
                            <h4 class="text-xl font-semibold mb-3 text-cyan-400 border-b border-slate-700 pb-2">Form Focus Points</h4>
                            <div class="text-slate-200 space-y-3">
                                ${tipsContent}
                            </div>
                        </div>
                    `;
        }

        // Helper function to generate the HTML for a single roadmap item
        function createRoadmapItemHtml(exercise, index, statusText, borderColor, bgColor, opacity, statusClass = 'text-gray-500') {
            // Only show the main group in the simple roadmap list
            const { mainGroup } = parseFocusDisplay(exercise.focus);

            return `
                        <div class="${bgColor} p-4 rounded-lg shadow-md border-l-4 ${borderColor} flex justify-between items-center ${opacity}">
                            <div>
                                <p class="text-md font-semibold text-gray-100">${index + 1}. ${exercise.name}</p>
                                <p class="text-sm text-slate-400">Sets/Reps: ${exercise.setsReps}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold text-cyan-400 block">${mainGroup}</span>
                                <span class="text-xs font-medium ${statusClass} block">${statusText}</span>
                            </div>
                        </div>
                    `;
        }

        // Controls moving through the workout and marking status
        function handleNavigation(action) {
            if (currentExerciseIndex < currentWorkout.length) {
                // Mark the exercise status before moving
                currentWorkout[currentExerciseIndex].status = action;
                currentExerciseIndex++;
            }

            if (currentExerciseIndex < currentWorkout.length) {
                // Move to next exercise
                renderCurrentExercise();
            } else {
                // Workout finished
                const roadmap = document.getElementById('workout-roadmap');
                // --- START: UPDATED COMPLETION MESSAGE ---
                roadmap.innerHTML = `
                            <div class="text-center bg-slate-900 p-10 rounded-xl shadow-2xl border border-slate-800">
                                <h2 class="text-3xl font-bold text-emerald-400 mb-4">SESSION COMPLETE!</h2>
                                <p class="text-lg text-slate-200">Great work, you crushed that session!</p>
                                <button onclick="window.location.reload()" class="mt-6 bg-cyan-600 text-slate-950 font-bold py-3 px-5 rounded-lg hover:bg-cyan-500 transition-colors duration-300 focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 focus:ring-offset-slate-900 shadow-lg shadow-cyan-500/30">
                                    START NEW WORKOUT
                                </button>
                            </div>
                        `;
                // --- END: UPDATED COMPLETION MESSAGE ---
            }
        }

        // Fetches the detailed form tips for a single exercise using a grounded API call
        async function fetchTipsForExercise(index) {
            const exercise = currentWorkout[index];
            if (exercise.tips || exercise.isFetchingTips) return;

            exercise.isFetchingTips = true;
            renderCurrentExercise(); // Show loading spinner

            // Instruction ensures raw lists separated by the unique separator string
            // Updated user query to use less technical terms ("Proper Technique" and "Common Mistakes")
            const userQuery = `Act as an expert strength and conditioning coach. For the exercise "${exercise.name}", provide the proper form Proper Technique (Do's) and Common Mistakes (Don'ts). The response MUST contain ONLY two sections: 1) The 'DO' points as a concise bulleted list. 2) The 'DON'T' points as a concise bulleted list. Separate the two lists with the exact text: ---SEPARATOR---. Do NOT include any introductory sentence, headers (like DO or DON'T), or concluding remarks. Just provide the raw list items (start with * or -). Each list should have 3 to 4 points.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            // Explicitly define the full API URL for correct runtime authentication
            const FULL_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            try {
                const response = await exponentialBackoffFetch(FULL_API_URL, options);

                if (!response.ok) {
                    let errorMsg = `status ${response.status}`;
                    try {
                        const errorResult = await response.json();
                        errorMsg = errorResult.error?.message || errorMsg;
                    } catch (e) { /* non-JSON response */ }
                    throw new Error(`API Error: ${errorMsg}`);
                }

                const result = await response.json();
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (responseText) {
                    currentWorkout[index].tips = responseText.trim();
                } else {
                    currentWorkout[index].tips = `<p class="text-red-400">Could not retrieve detailed form focus points.</p>`;
                }

            } catch (error) {
                console.error("Cue Fetch Error:", error);
                currentWorkout[index].tips = `<p class="text-red-400">Failed to load cues due to an API error.</p>`;
            } finally {
                exercise.isFetchingTips = false;
                // Re-render the display once tips are available (or failed)
                if (index === currentExerciseIndex) {
                    renderCurrentExercise();
                }
            }
        }


        // Renders the main active exercise card
        async function renderCurrentExercise() {
            const currentExercise = currentWorkout[currentExerciseIndex];
            const displayEl = document.getElementById('current-exercise-display');

            // Render the main card
            displayEl.innerHTML = createRoadmapCard(currentExercise);
            renderFullRoadmap(); // Render the full list of exercises

            // --- ON-DEMAND TIP FETCHING ---
            // If tips haven't been fetched yet, start the fetch
            if (!currentExercise.tips && !currentExercise.isFetchingTips) {
                fetchTipsForExercise(currentExerciseIndex);
            }

            // Update navigation button text (e.g., "Finish Workout")
            const doneBtn = document.getElementById('done-btn');

            if (doneBtn) {
                if (currentExerciseIndex === currentWorkout.length - 1) {
                    // Updated Button Text
                    doneBtn.textContent = "FINISH WORKOUT";
                } else {
                    // Updated Button Text
                    doneBtn.textContent = "Completed & Next";
                }
            }
        }

        // Renders the full roadmap list (completed, skipped, and upcoming)
        function renderFullRoadmap() {
            const historyListEl = document.getElementById('history-list');
            const upcomingListEl = document.getElementById('upcoming-list');

            historyListEl.innerHTML = '';
            upcomingListEl.innerHTML = '';

            // 1. Separate exercises into History and Future
            const historyExercises = currentWorkout.filter((_, index) => index < currentExerciseIndex);
            const futureExercises = currentWorkout.filter((_, index) => index > currentExerciseIndex);

            // 2. Render History (COMPLETED/SKIPPED) - ABOVE
            if (historyExercises.length > 0) {
                // Updated Header: Less technical
                historyListEl.innerHTML += `<h3 class="text-lg font-semibold text-slate-400 mb-2 border-b border-slate-800 pb-1 uppercase tracking-wider">Session Log</h3>`;
                historyExercises.forEach((exercise, index) => {
                    const statusText = exercise.status === 'SKIPPED' ? 'SKIPPED' : 'COMPLETED';
                    const borderColor = exercise.status === 'SKIPPED' ? 'border-amber-500' : 'border-emerald-500';
                    const statusClass = exercise.status === 'SKIPPED' ? 'text-amber-400' : 'text-emerald-400';
                    const bgColor = 'bg-slate-900';
                    const opacity = 'opacity-70';

                    historyListEl.innerHTML += createRoadmapItemHtml(exercise, index, statusText, borderColor, bgColor, opacity, statusClass);
                });
            }

            // 3. Render Future (UPCOMING) - BELOW
            if (futureExercises.length > 0) {
                // Updated Header: Less technical (already updated above, making sure it's here)
                upcomingListEl.innerHTML += `<h3 class="text-lg font-semibold text-slate-400 mb-2 border-b border-slate-800 pb-1 uppercase tracking-wider">Next Exercises</h3>`;
                futureExercises.forEach((exercise, indexOffset) => {
                    const index = currentExerciseIndex + 1 + indexOffset; // Correct original index
                    const statusText = 'NEXT UP';
                    const borderColor = 'border-slate-700';
                    const bgColor = 'bg-slate-900';
                    const opacity = 'opacity-75';
                    const statusClass = 'text-slate-500';

                    upcomingListEl.innerHTML += createRoadmapItemHtml(exercise, index, statusText, borderColor, bgColor, opacity, statusClass);
                });
            }
        }

        // Switches view from the initial list to the active roadmap
        function startWorkout() {
            if (currentWorkout.length === 0) return;

            document.getElementById('generator-card').classList.add('hidden');
            document.getElementById('generated-workout-content').classList.add('hidden');
            document.getElementById('workout-roadmap').classList.remove('hidden');

            // Attach navigation listeners
            const doneBtn = document.getElementById('done-btn');
            const skipBtn = document.getElementById('skip-btn');

            // Set up handlers to pass the action type
            if (doneBtn) doneBtn.onclick = () => handleNavigation('COMPLETED');
            if (skipBtn) skipBtn.onclick = () => handleNavigation('SKIPPED');

            currentExerciseIndex = 0;
            renderCurrentExercise();
        }

        // Helper to update the state of manual checkboxes (enabled/disabled)
        function updateCheckboxState(shouldDisable, groupsToSelect = []) {
            const muscleSelector = document.getElementById('muscle-group-selector');
            const checkboxes = muscleSelector.querySelectorAll('input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                const label = checkbox.closest('.muscle-label');
                const labelDiv = checkbox.nextElementSibling;

                // 1. Reset visual and disabled states for all
                checkbox.disabled = false;
                label.classList.remove('disabled-state');

                // 2. Base styling for manual mode
                labelDiv.className = 'text-center p-3 border-2 border-slate-700 bg-slate-800 text-slate-300 rounded-lg font-semibold hover:bg-slate-700 transition-all';
                labelDiv.style.cursor = 'pointer';

                if (shouldDisable) {
                    // --- PPL MODE: Disable everything and lock selections ---
                    checkbox.disabled = true;
                    label.classList.add('disabled-state');

                    // Reset styling for the disabled state to avoid conflicting classes
                    labelDiv.className = 'text-center p-3 rounded-lg font-semibold transition-all duration-200';
                    labelDiv.style.cursor = 'not-allowed';

                    const isSelected = groupsToSelect.includes(checkbox.value);
                    checkbox.checked = isSelected; // CRITICAL: Force the state change for PPL logic

                    if (isSelected) {
                        // PPL selected group (Active, but disabled) - Darker Cyan Lock
                        labelDiv.classList.add('bg-cyan-700', 'border-cyan-700', 'border-2', 'text-slate-950', 'opacity-90');

                    } else {
                        // PPL unselected group (Inactive and disabled) - Blended, Dashed Border Lock
                        labelDiv.classList.add('bg-slate-950', 'border-dashed', 'border-2', 'border-slate-700', 'text-slate-500');
                    }
                } else {
                    // --- MANUAL MODE: Ensure all are enabled ---
                    // The checked state remains whatever it was before (or as set by the user).
                }
            });
        }

        // Handler for the PPL dropdown change or PPL Core toggle
        function handlePPLSelection() {
            const pplSelector = document.getElementById('ppl-selector');
            const pplCoreContainer = document.getElementById('ppl-core-toggle-container');
            const pplIncludeCore = document.getElementById('ppl-include-core');
            const selectedPPL = pplSelector.value;

            if (selectedPPL === 'None') {
                // MANUAL MODE
                pplCoreContainer.classList.add('hidden'); // Hide PPL Core toggle
                updateCheckboxState(false); // Enable manual selection for all
            } else {
                // PPL MODE
                pplCoreContainer.classList.remove('hidden'); // Show PPL Core toggle

                let groupsToSelect = pplMap[selectedPPL];

                // If PPL Core is ON, include Core in the list of selected groups for updateCheckboxState
                if (pplIncludeCore && pplIncludeCore.checked) {
                    groupsToSelect = [...groupsToSelect, 'Core'];
                }

                // Disable manual selection for all, and visually select the PPL groups
                updateCheckboxState(true, groupsToSelect);
            }
        }

        // Utility for API calls with backoff
        async function exponentialBackoffFetch(url, options, attempt = 1) {
            try {
                const response = await fetch(url, options);
                if (!response.ok && response.status === 429 && attempt < MAX_RETRIES) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return exponentialBackoffFetch(url, options, attempt + 1);
                }
                return response;
            } catch (error) {
                if (attempt < MAX_RETRIES) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return exponentialBackoffFetch(url, options, attempt + 1);
                }
                throw error;
            }
        }


        // The main function to generate the workout plan via Gemini API
        async function generateWorkout() {
            let selectedGroups = [];

            // Read whatever is currently checked in the visible muscle group selector.
            document.querySelectorAll('#muscle-group-selector input:checked').forEach(input => {
                selectedGroups.push(input.value);
            });

            const durationInput = document.getElementById('workout-duration');
            const selectedDuration = parseInt(durationInput.value, 10);
            const workoutTypeSelect = document.getElementById('workout-type');
            const selectedGoal = workoutTypeSelect.value;
            const preset = workoutPresets[selectedGoal];

            const placeholder = document.getElementById('workout-placeholder');
            const loader = document.getElementById('workout-loader');
            const list = document.getElementById('workout-list');

            if (selectedGroups.length === 0) {
                placeholder.innerHTML = `<p class="text-lg text-red-400">INPUT ERROR: Please select at least one muscle group, either manually or using the Quick Select above.</p>`;
                placeholder.classList.remove('hidden');
                loader.classList.add('hidden');
                list.innerHTML = "";
                return;
            }

            // --- CRITICAL: Clear previous plans and show loader ---
            list.innerHTML = "";
            placeholder.classList.add('hidden');
            loader.classList.remove('hidden');
            // Hide roadmap if it was visible
            document.getElementById('workout-roadmap').classList.add('hidden');
            document.getElementById('generated-workout-content').classList.remove('hidden');


            // --- DYNAMIC EXERCISE COUNT LOGIC ---
            const durationHours = selectedDuration / 60;
            let minScaledExercises = Math.max(1, Math.round(preset.minEx * durationHours * 0.7)); // Reduced factor
            let maxScaledExercises = Math.max(minScaledExercises, Math.round(preset.maxEx * durationHours * 1.3)); // Increased factor

            if (selectedGoal === 'Strength' || selectedGoal === 'HIIT') {
                maxScaledExercises = Math.min(maxScaledExercises, 6);
            }
            maxScaledExercises = Math.min(maxScaledExercises, 10); // Cap at 10 exercises

            const numExercises = `${minScaledExercises} to ${maxScaledExercises}`;

            // --- SYSTEM INSTRUCTION (Uses less technical language) ---
            const systemInstruction = `You are an expert fitness coach. The user is a teen athlete and only has access to a weight bench, a long barbell, an EZ curl bar, adjustable dumbbells/plates, and a LEG EXTENSION/CURL ATTACHMENT. Generate a **${selectedGoal}** workout plan with ${numExercises} exercises *only* using this equipment, based on the user's selected muscle groups. The workout must be designed to fit a total duration of ${selectedDuration} minutes.

                    For the JSON response:
                    1. The 'setsReps' field MUST be formatted exactly as 'X sets of Y reps' (e.g., '3 sets of 8-12 reps').
                    2. The 'restTime' field MUST be formatted exactly as 'X seconds' (e.g., '90 seconds'). Base the value on a typical rest time for a ${selectedGoal} workout (e.g., use '${preset.restTarget}').
                    3. The 'focus' field MUST be formatted as 'Main Muscle Group (Specific Muscles Hit)' (e.g., 'Back (Lats, Rhomboids, Biceps)').
                    4. The 'description' must be a concise (1-2 sentence) explanation of the exercise.

                    All advice must be safe and age-appropriate.`;

            const userQuery = `Generate a workout for the following muscle groups: ${selectedGroups.join(', ')}.`;

            // Define the JSON schema for the structured response
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        name: { type: "STRING" },
                        focus: { type: "STRING" },
                        setsReps: { type: "STRING" },
                        restTime: { type: "STRING" }, // New field for formatted rest time
                        description: { type: "STRING" },
                    },
                    required: ["name", "focus", "setsReps", "restTime", "description"]
                }
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            // Explicitly define the full API URL for correct runtime authentication
            const FULL_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            try {
                const response = await exponentialBackoffFetch(FULL_API_URL, options);

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorResult = await response.json();
                        errorMsg = errorResult.error?.message || errorMsg;
                    } catch (e) { /* non-JSON response */ }
                    throw new Error(`API Error: ${errorMsg}`);
                }

                const result = await response.json();

                loader.classList.add('hidden'); // Hide loader on success
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const exercises = JSON.parse(jsonText);

                    // Initialize tips/fetching status and the new 'status' field for the roadmap feature
                    currentWorkout = exercises.map(ex => ({
                        ...ex,
                        tips: null,
                        isFetchingTips: false,
                        status: null // New field: 'COMPLETED' or 'SKIPPED'
                    }));


                    if (currentWorkout.length === 0) {
                        placeholder.innerHTML = `<p class="text-lg text-slate-400">No exercises found for this combination. Try selecting different muscle groups or generating again.</p>`;
                        placeholder.classList.remove('hidden');
                        return;
                    }

                    // Populate the initial list summary
                    currentWorkout.forEach((exercise, index) => {
                        list.innerHTML += createInitialListCard(exercise, index);
                    });

                    // Add the START button
                    // Updated Button Text
                    list.innerHTML += `
                                <button id="start-workout-btn" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-indigo-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-slate-900 shadow-lg shadow-indigo-500/30">
                                    START WORKOUT
                                </button>
                            `;
                    document.getElementById('start-workout-btn').addEventListener('click', startWorkout);

                    document.getElementById('workout-list').classList.remove('hidden');


                } else {
                    placeholder.innerHTML = `<p class="text-lg text-red-400">ERROR: Workout generation failed. Please check parameters and retry.</p>`;
                    placeholder.classList.remove('hidden');
                }

            } catch (error) {
                loader.classList.add('hidden'); // Hide loader on error
                placeholder.innerHTML = `<p class="text-lg text-red-400 font-semibold">TERMINAL ERROR:</p><p class="text-md text-slate-400 mt-2">${error.message}</p>`;
                placeholder.classList.remove('hidden');
                console.error("Workout Generation Error:", error);
            }
        }

        // On page load, set up the new generator
        document.addEventListener('DOMContentLoaded', () => {

            // Populate muscle group checkboxes
            const selectorContainer = document.getElementById('muscle-group-selector');
            muscleGroups.forEach(group => {
                const id = group.toLowerCase().replace(' ', '-');
                selectorContainer.innerHTML += `
                            <label for="${id}" class="muscle-label cursor-pointer">
                                <input type="checkbox" id="${id}" value="${group}" class="sr-only">
                                <div class="text-center p-3 border-2 border-slate-700 bg-slate-800 text-slate-300 rounded-lg font-semibold hover:bg-slate-700">
                                    ${group}
                                </div>
                            </label>
                        `;
            });

            // Set up PPL listeners
            const pplSelector = document.getElementById('ppl-selector');
            const pplIncludeCore = document.getElementById('ppl-include-core');

            pplSelector.addEventListener('change', handlePPLSelection);
            if (pplIncludeCore) {
                pplIncludeCore.addEventListener('change', handlePPLSelection);
            }

            // Trigger initial state application
            handlePPLSelection();


            // --- Dynamic Duration Slider Listener ---
            const durationSlider = document.getElementById('workout-duration');
            const durationDisplay = document.getElementById('duration-display');
            durationSlider.addEventListener('input', () => {
                const minutes = durationSlider.value;
                let display = `${minutes} Minutes`;
                if (minutes == 120) {
                    display = '120 Minutes (2 Hours)';
                }
                durationDisplay.textContent = display;
            });
            // Set initial display
            durationDisplay.textContent = `${durationSlider.value} Minutes`;


            // Attach listener to the main generate button
            const generateButton = document.getElementById('generate-btn');
            generateButton.addEventListener('click', generateWorkout);
        });
    </script>
</body>
</html>