
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Workout Planner (Dark Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom checkbox style */
        .muscle-label {
            transition: all 0.2s ease-in-out;
        }
        .muscle-label input:checked + div {
            background-color: #3b82f6; /* blue-600 */
            color: white;
            border-color: #3b82f6;
        }
        .muscle-label input:focus + div {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        /* Custom list style for Do's/Don'ts */
        #form-checklist ul {
            list-style: disc;
            padding-left: 1.5rem;
            color: #d1d5db; /* Light gray text for lists */
        }
        #form-checklist li {
            margin-bottom: 0.5rem;
        }

        /* Custom styling for the range slider (for dark theme visibility) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6; /* Blue-500 */
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6; /* Blue-500 */
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8" id="main-header">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-50">Dynamic Workout Planner</h1>
            <p class="text-gray-400 mt-2">Generate a custom workout based on your time, goal, and muscles.</p>
        </header>

        <!-- Workout Generator/Input Card -->
        <div id="generator-card" class="bg-gray-800 p-6 rounded-xl shadow-xl mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-50">Create Your Workout</h2>
            
            <!-- Duration Selector -->
            <h3 class="text-lg font-semibold mb-2 text-gray-50">1. Select Duration: <span id="duration-display" class="font-bold text-blue-400">45 Minutes</span></h3>
            <div class="mb-6">
                <input type="range" id="workout-duration" min="15" max="120" step="5" value="45" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <span>15 Mins</span>
                    <span>120 Mins (2 Hrs)</span>
                </div>
            </div>

            <!-- Workout Type Selector -->
            <h3 class="text-lg font-semibold mb-2 text-gray-50">2. Select Workout Type</h3>
            <select id="workout-type" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-200">
                <option value="Hypertrophy" selected>Muscle Growth (Hypertrophy)</option>
                <option value="Strength">Strength & Power (Heavy Lifting)</option>
                <option value="HIIT">High-Intensity Interval Training (HIIT)</option>
            </select>
            
            <!-- Muscle Group Selector -->
            <h3 class="text-lg font-semibold mb-2 text-gray-50">3. Choose Muscle Groups</h3>
            <div id="muscle-group-selector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-6">
                <!-- Muscle group checkboxes will be injected here by JS -->
            </div>

            <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2 1M4 7l2-1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1m2 1l-2 1m2-1V16a2.5 2.5 0 015 0v2.5m0 0l2 1m-2-1l2-1m-2 1v2.5m-5-10.5l2-1m-2 1l2 1m-2 1V6a2.5 2.5 0 015 0v2.5m0 0l-2-1m2 1l-2 1m2-1V11" />
                </svg>
                Generate My Workout
            </button>
        </div>

        <!-- Main content area for generated workout -->
        <main id="workout-content">
            <section id="generated-workout-content">
                <div id="workout-placeholder" class="text-center text-gray-400 bg-gray-800 p-10 rounded-xl shadow-md">
                    <p class="text-lg">Your generated workout will appear here.</p>
                    <p class="text-sm">Select duration, goal, and muscle groups above and click "Generate".</p>
                </div>
                
                <div id="workout-loader" class="hidden text-center text-blue-400 bg-gray-800 p-10 rounded-xl shadow-md">
                    <div class="flex justify-center items-center">
                        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mr-3"></div>
                        <p class="text-lg font-semibold">Generating your custom plan...</p>
                    </div>
                </div>

                <!-- Initial List View (before starting roadmap) -->
                <div id="workout-list" class="space-y-4">
                    <!-- Generated exercise summaries and Start Button will be injected here by JS -->
                </div>
            </section>
        
            <!-- START: New Roadmap View (hidden by default) -->
            <div id="workout-roadmap" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-50 text-center">Active Workout Roadmap</h2>

                <!-- 1. Current Exercise Card (BIG CARD) -->
                <div id="current-exercise-display" class="bg-gray-700 p-6 rounded-xl shadow-2xl mb-6 border-4 border-blue-500">
                    <!-- Content injected here -->
                </div>

                <!-- 2. Navigation -->
                <div class="flex justify-between space-x-4 mb-8">
                    <button id="skip-btn" class="w-full bg-yellow-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-yellow-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                        Skip Exercise
                    </button>
                    <button id="done-btn" class="w-full bg-green-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Done & Next Exercise
                    </button>
                </div>

                <!-- 3. Roadmap (Smaller Exercises) -->
                <div id="roadmap-list" class="space-y-3">
                    <!-- Completed and Upcoming roadmap items injected here -->
                </div>
            </div>
            <!-- END: New Roadmap View -->

        </main>
    </div>

    <script>
        // *** IMPORTANT: API Key is set to an empty string ***
        const API_KEY = "%%%GEMINI_KEY_INJECTION_PLACEHOLDER%%%";
        const MAX_RETRIES = 5;

        // Global State for the Active Workout
        let currentWorkout = [];
        let currentExerciseIndex = 0;
        
        // YouTube search filter for 4-20 minute videos
        const YOUTUBE_DURATION_FILTER = '&sp=EgQQARgB'; 

        // Data structure for workout types and their rest time guidance (in seconds)
        const workoutPresets = {
            Hypertrophy: { minEx: 5, maxEx: 7, restTarget: "90 seconds", restDesc: "to create metabolic stress." },
            Strength: { minEx: 2, maxEx: 4, restTarget: "180 seconds (3 minutes)", restDesc: "to ensure max recovery and performance." },
            HIIT: { minEx: 4, maxEx: 5, restTarget: "30 seconds", restDesc: "or a work-to-rest ratio." }
        };

        // List of muscle groups for the checkboxes
        const muscleGroups = [
            'Chest', 'Back', 'Quads', 'Hamstrings', 'Glutes', 'Shoulders', 
            'Biceps', 'Triceps', 'Core'
        ];

        // Helper function to format the raw tip string into HTML lists (UL/LI)
        function formatTipsToHtml(rawTipsText) {
            if (!rawTipsText) return `<p class="text-gray-400 italic">No detailed tips available yet.</p>`;

            // Split the raw text using the unique separator defined in the prompt
            const parts = rawTipsText.split('---SEPARATOR---');
            if (parts.length !== 2) {
                // Fallback for unexpected format
                return `<p class="text-red-400">Error parsing tips content. Please try skipping and re-generating the tips.</p>`;
            }

            const doListText = parts[0].trim();
            const dontListText = parts[1].trim();

            // Helper to convert raw bullet points (* text) into HTML list
            const listToHtml = (listText) => {
                if (listText.length === 0) return '<ul><li>No points provided.</li></ul>';
                
                // Split by new line, filter out empty lines, and map to <li> tags
                return `<ul>${listText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.startsWith('*') || line.startsWith('-')) // Only keep bullet points
                    .map(line => `<li>${line.substring(1).trim()}</li>`) // Remove the leading * or -
                    .join('')}</ul>`;
            };

            return `
                <div class="space-y-4">
                    <h4 class="text-xl font-bold text-green-400">DO'S</h4>
                    ${listToHtml(doListText)}
                    
                    <h4 class="text-xl font-bold text-red-400">DON'TS</h4>
                    ${listToHtml(dontListText)}
                </div>
            `;
        }
        
        // Helper function to generate the YouTube search link HTML
        function createVideoLinkHtml(exerciseName, filter = false) {
            const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(exerciseName + " exercise tutorial")}`;
            const finalUrl = filter ? searchUrl + YOUTUBE_DURATION_FILTER : searchUrl;

            return `
                <a href="${finalUrl}" target="_blank" class="text-sm font-medium text-blue-400 hover:text-blue-300 transition-colors flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-4 h-4 mr-1" viewBox="0 0 16 16">
                      <path d="M8.051 1.999h.089c.822.003 4.987.033 6.107.334.66.163.92.512 1.07.994.12.428.32 1.444.32 2.709v.875c0 1.265-.2 2.28-.32 2.709-.15.482-.41.831-1.07.994-1.12.3-5.285.33-6.107.334h-.089c-.822-.003-4.987-.033-6.107-.334C.89 12.684.63 12.335.48 11.853c-.12-.428-.32-1.444-.32-2.709v-.875c0-1.265.2-2.28.32-2.709.15-.482.41-.831 1.07-.994 1.12-.3 5.285-.33 6.107-.334zM11.62 9.172a.6.6 0 01-.796.536l-3.564-2.18a.6.6 0 010-1.071l3.564-2.181a.6.6 0 01.796.535v4.32z"/>
                    </svg>
                    Watch Instructional Video
                </a>
            `;
        }
        
        // Helper to parse the focus string (e.g., "Chest (Pecs, Delts)") into structured data
        function parseFocusDisplay(focusString) {
            const match = focusString.match(/^([^ (]+)\s*(?:\((.*)\))?$/);
            if (!match) return { mainGroup: focusString, specifics: [] };

            const mainGroup = match[1].trim();
            const specificMusclesString = match[2] || '';
            const specifics = specificMusclesString.split(',').map(s => s.trim()).filter(s => s.length > 0);

            return { mainGroup, specifics };
        }
        
        // Helper to render the target area with floating tags
        function renderTargetAreaTags(focusString) {
            const { mainGroup, specifics } = parseFocusDisplay(focusString);
            
            // Main Muscle Group (Big and Blue)
            let html = `<span class="font-extrabold text-xl text-blue-400 block">${mainGroup}</span>`;
            
            // Specific Muscle Tags (Floating Labels)
            if (specifics.length > 0) {
                html += `<div class="flex flex-wrap gap-2 mt-2">`;
                specifics.forEach(muscle => {
                    // Use a slightly darker gray for the tags for contrast
                    html += `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-gray-600 text-gray-200">${muscle}</span>`;
                });
                html += `</div>`;
            }
            return html;
        }


        // Renders the detailed card for the initial generated list (Planner View)
        function createInitialListCard(exercise, index) {
            const videoLinkHtml = createVideoLinkHtml(exercise.name, true);

            return `
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-xl font-bold text-blue-400 mb-3">${index + 1}. ${exercise.name}</h3>

                    <!-- Structured Metrics Display (Stacked) -->
                    <div class="space-y-2 mb-4">
                        <div class="mb-2">
                            <p class="font-semibold text-gray-400 mb-1">Target Area:</p>
                            ${renderTargetAreaTags(exercise.focus)}
                        </div>
                        <p class="text-md text-gray-200"><span class="font-semibold text-gray-400">Sets/Reps:</span> ${exercise.setsReps}</p>
                        <p class="text-md text-gray-200"><span class="font-semibold text-gray-400">Rest Between Sets:</span> ${exercise.restTime}</p>
                    </div>

                    <!-- Short Explanation -->
                    <div class="bg-gray-700 p-3 rounded-lg mb-4">
                        <p class="text-sm text-gray-400 font-semibold mb-1">Explanation:</p>
                        <p class="text-gray-200">${exercise.description}</p>
                    </div>

                    <!-- Video Link -->
                    <div class="flex justify-center">
                        ${videoLinkHtml}
                    </div>
                </div>
            `;
        }

        // Renders the large card for the current exercise in the Roadmap View - WITH TIPS
        function createRoadmapCard(exercise) {
            
            // Define tip content/loading message
            let tipsContent;
            if (exercise.tips) {
                // If tips are fetched, format them into HTML
                tipsContent = formatTipsToHtml(exercise.tips); 
            } else if (exercise.isFetchingTips) {
                // Show loading spinner
                tipsContent = `
                    <div class="flex justify-center items-center text-blue-400">
                        <div class="w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mr-3"></div>
                        <p>Loading detailed form tips...</p>
                    </div>
                `;
            } else {
                // Failed or pending fetch
                tipsContent = `<p class="text-red-400">Failed to load tips.</p>`;
            }

            // Create YouTube link using the helper function (with filter enabled)
            const videoLinkHtml = createVideoLinkHtml(exercise.name, true);

            return `
                <div class="text-center">
                    <p class="text-sm font-medium text-blue-300 uppercase tracking-wider">Current Exercise ${currentExerciseIndex + 1} / ${currentWorkout.length}</p>
                    
                    <h3 class="text-3xl font-extrabold text-white mt-1 mb-2">${exercise.name}</h3>

                    <!-- Video Link -->
                    <div class="mb-4">
                        ${videoLinkHtml}
                    </div>
                </div>
                
                <!-- Structured Display of Metrics -->
                <div class="grid grid-cols-3 gap-4 text-center mb-6">
                    <div class="bg-gray-800 p-3 rounded-lg border-b-4 border-blue-500 text-left">
                        <p class="text-xs text-gray-400 font-medium text-center">TARGET AREA</p>
                        <div class="text-center mt-1">
                            ${renderTargetAreaTags(exercise.focus)}
                        </div>
                    </div>
                    <div class="bg-gray-800 p-3 rounded-lg border-b-4 border-blue-500">
                        <p class="text-xs text-gray-400 font-medium">SETS / REPS</p>
                        <p class="text-lg font-bold text-gray-100">${exercise.setsReps}</p>
                    </div>
                    <div class="bg-gray-800 p-3 rounded-lg border-b-4 border-blue-500">
                        <p class="text-xs text-gray-400 font-medium">REST TIME</p>
                        <p class="text-lg font-bold text-gray-100">${exercise.restTime}</p>
                    </div>
                </div>
                
                <!-- Short Explanation -->
                <div class="bg-gray-800 p-5 rounded-xl shadow-inner mt-4 mb-4">
                    <h4 class="text-xl font-semibold mb-2 text-gray-50 border-b border-gray-700 pb-1">Explanation</h4>
                    <p class="text-gray-200">${exercise.description}</p>
                </div>
                
                <!-- Detailed Form Checklist Section (Tips Content) - Now always visible and formatted -->
                <div id="form-checklist" class="bg-gray-800 p-5 rounded-xl shadow-inner mt-4">
                    <h4 class="text-xl font-semibold mb-3 text-gray-50 border-b border-gray-700 pb-2">Execution Checklist</h4> 
                    <div class="text-gray-200 space-y-3">
                        ${tipsContent}
                    </div>
                </div>
            `;
        }
        
        // Helper function to generate the HTML for a single roadmap item
        function createRoadmapItemHtml(exercise, index, statusText, borderColor, bgColor, opacity) {
            // Only show the main group in the simple roadmap list
            const { mainGroup } = parseFocusDisplay(exercise.focus);

            return `
                <div class="${bgColor} p-4 rounded-lg shadow-md border-l-4 ${borderColor} flex justify-between items-center ${opacity}">
                    <div>
                        <p class="text-md font-semibold text-gray-100">${index + 1}. ${exercise.name}</p>
                        <p class="text-sm text-gray-400">Sets/Reps: ${exercise.setsReps}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-bold text-blue-400 block">${mainGroup}</span>
                        <span class="text-xs font-medium text-gray-500 block">${statusText}</span>
                    </div>
                </div>
            `;
        }

        // Renders all exercises in the roadmap below the main card
        function renderFullRoadmap() {
            const roadmapList = document.getElementById('roadmap-list');
            
            // Create sections for clarity
            let completedHtml = '';
            let upcomingHtml = '';

            for (let i = 0; i < currentWorkout.length; i++) {
                const exercise = currentWorkout[i];
                
                let statusText = '';
                let borderColor = '';
                let bgColor = 'bg-gray-800';
                let opacity = '';

                if (i < currentExerciseIndex) {
                    // COMPLETED
                    statusText = 'COMPLETED';
                    borderColor = 'border-green-500';
                    bgColor = 'bg-gray-700';
                    opacity = 'opacity-50'; // Dim completed items
                    completedHtml += createRoadmapItemHtml(exercise, i, statusText, borderColor, bgColor, opacity);
                } else if (i > currentExerciseIndex) {
                    // UPCOMING
                    statusText = 'UPCOMING';
                    borderColor = 'border-gray-600';
                    bgColor = 'bg-gray-800';
                    upcomingHtml += createRoadmapItemHtml(exercise, i, statusText, borderColor, bgColor, opacity);
                }
                // Current exercise (i === currentExerciseIndex) is handled by the big card, so we skip it here.
            }
            
            // Inject the content into the main roadmap list element
            let finalHtml = '';
            if (completedHtml) {
                finalHtml += `<h3 class="text-lg font-semibold mb-3 text-gray-400">Completed Exercises:</h3><div class="space-y-3 mb-6">${completedHtml}</div><hr class="border-gray-700 my-4">`;
            }
            
            if (upcomingHtml) {
                finalHtml += `<h3 class="text-lg font-semibold mb-3 text-gray-400">Upcoming Exercises:</h3><div class="space-y-3">${upcomingHtml}</div>`;
            }

            roadmapList.innerHTML = finalHtml;
        }

        // Controls moving through the workout
        function handleNavigation(direction) {
            currentExerciseIndex += direction;

            if (currentExerciseIndex < currentWorkout.length) {
                renderCurrentExercise();
            } else {
                // Workout finished
                const roadmap = document.getElementById('workout-roadmap');
                roadmap.innerHTML = `
                    <div class="text-center bg-gray-700 p-10 rounded-xl shadow-2xl">
                        <h2 class="text-3xl font-bold text-green-400 mb-4">🥳 Workout Complete!</h2>
                        <p class="text-lg text-gray-200">Great job finishing your session!</p>
                        <button onclick="window.location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                            Plan New Workout
                        </button>
                    </div>
                `;
            }
        }

        // Fetches the detailed form tips for a single exercise using a grounded API call
        async function fetchTipsForExercise(index) {
            const exercise = currentWorkout[index];
            if (exercise.tips || exercise.isFetchingTips) return;
            
            exercise.isFetchingTips = true;
            renderCurrentExercise(); // Show loading spinner

            // Instruction ensures raw lists separated by the unique separator string
            const userQuery = `Act as an expert strength and conditioning coach. For the exercise "${exercise.name}", provide the proper form Do's and Don'ts. The response MUST contain ONLY two sections: 1) The 'DO' points as a concise bulleted list. 2) The 'DON'T' points as a concise bulleted list. Separate the two lists with the exact text: ---SEPARATOR---. Do NOT include any introductory sentence, headers (like DO or DON'T), or concluding remarks. Just provide the raw list items (start with * or -). Each list should have 3 to 4 points.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
            };
            
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };
            
            // Explicitly define the full API URL for correct runtime authentication
            const FULL_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            try {
                const response = await exponentialBackoffFetch(FULL_API_URL, options);

                if (!response.ok) {
                     let errorMsg = `status ${response.status}`;
                     try {
                        const errorResult = await response.json();
                        errorMsg = errorResult.error?.message || errorMsg;
                    } catch (e) { /* non-JSON response */ }
                     throw new Error(`API Error: ${errorMsg}`);
                }
                
                const result = await response.json();
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (responseText) {
                    currentWorkout[index].tips = responseText.trim();
                } else {
                    currentWorkout[index].tips = `<p class="text-red-400">Could not retrieve detailed form tips.</p>`;
                }

            } catch (error) {
                console.error("Tip Fetch Error:", error);
                currentWorkout[index].tips = `<p class="text-red-400">Failed to load tips due to an API error.</p>`;
            } finally {
                exercise.isFetchingTips = false;
                // Re-render the display once tips are available (or failed)
                if (index === currentExerciseIndex) {
                    renderCurrentExercise();
                }
            }
        }


        // Renders the main active exercise card
        async function renderCurrentExercise() {
            const currentExercise = currentWorkout[currentExerciseIndex];
            const displayEl = document.getElementById('current-exercise-display');
            
            // Render the main card
            displayEl.innerHTML = createRoadmapCard(currentExercise);
            renderFullRoadmap(); // Render the full list of exercises
            
            // --- ON-DEMAND TIP FETCHING ---
            // If tips haven't been fetched yet, start the fetch
            if (!currentExercise.tips && !currentExercise.isFetchingTips) {
                fetchTipsForExercise(currentExerciseIndex);
            }

            // Update navigation button text (e.g., "Finish Workout")
            const doneBtn = document.getElementById('done-btn');
            
            if (doneBtn) {
                if (currentExerciseIndex === currentWorkout.length - 1) {
                    doneBtn.textContent = "Finish Workout!";
                } else {
                    doneBtn.textContent = "Done & Next Exercise";
                }
            }
        }

        // Switches view from the initial list to the active roadmap
        function startWorkout() {
            if (currentWorkout.length === 0) return;

            document.getElementById('generator-card').classList.add('hidden');
            document.getElementById('generated-workout-content').classList.add('hidden');
            document.getElementById('workout-roadmap').classList.remove('hidden');

            // Attach navigation listeners (ensuring they are only added once)
            const doneBtn = document.getElementById('done-btn');
            const skipBtn = document.getElementById('skip-btn');

            // Use clear listeners/re-attach to be safe
            if(doneBtn) doneBtn.onclick = () => handleNavigation(1);
            if(skipBtn) skipBtn.onclick = () => handleNavigation(1);

            currentExerciseIndex = 0;
            renderCurrentExercise();
        }


        // Utility for API calls with backoff
        async function exponentialBackoffFetch(url, options, attempt = 1) {
            try {
                const response = await fetch(url, options);
                if (!response.ok && response.status === 429 && attempt < MAX_RETRIES) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return exponentialBackoffFetch(url, options, attempt + 1);
                }
                return response;
            } catch (error) {
                if (attempt < MAX_RETRIES) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay)); 
                    return exponentialBackoffFetch(url, options, attempt + 1);
                }
                throw error;
            }
        }
        

        // The main function to generate the workout plan via Gemini API
        async function generateWorkout() {
            const selectedGroups = [];
            document.querySelectorAll('#muscle-group-selector input:checked').forEach(input => {
                selectedGroups.push(input.value);
            });
            
            const durationInput = document.getElementById('workout-duration');
            const selectedDuration = parseInt(durationInput.value, 10); 
            const workoutTypeSelect = document.getElementById('workout-type');
            const selectedGoal = workoutTypeSelect.value;
            const preset = workoutPresets[selectedGoal];
            
            const placeholder = document.getElementById('workout-placeholder');
            const loader = document.getElementById('workout-loader');
            const list = document.getElementById('workout-list');

            if (selectedGroups.length === 0) {
                placeholder.innerHTML = `<p class="text-lg text-red-400">Please select at least one muscle group.</p>`;
                placeholder.classList.remove('hidden');
                loader.classList.add('hidden');
                list.innerHTML = "";
                return;
            }
            
            // --- CRITICAL: Clear previous plans and show loader ---
            list.innerHTML = "";
            placeholder.classList.add('hidden');
            loader.classList.remove('hidden');
            // Hide roadmap if it was visible
            document.getElementById('workout-roadmap').classList.add('hidden');
            document.getElementById('generated-workout-content').classList.remove('hidden');


            // --- DYNAMIC EXERCISE COUNT LOGIC ---
            const durationHours = selectedDuration / 60;
            let minScaledExercises = Math.max(1, Math.round(preset.minEx * durationHours * 0.7)); // Reduced factor
            let maxScaledExercises = Math.max(minScaledExercises, Math.round(preset.maxEx * durationHours * 1.3)); // Increased factor
            
            if (selectedGoal === 'Strength' || selectedGoal === 'HIIT') {
                maxScaledExercises = Math.min(maxScaledExercises, 6);
            }
            maxScaledExercises = Math.min(maxScaledExercises, 10); // Cap at 10 exercises
            
            const numExercises = `${minScaledExercises} to ${maxScaledExercises}`;
            
            // --- SYSTEM INSTRUCTION ---
            const systemInstruction = `You are an expert fitness planner. The user is a teen athlete and only has access to a weight bench, a long barbell, an EZ curl bar, adjustable dumbbells/plates, and a LEG EXTENSION/CURL ATTACHMENT. Generate a **${selectedGoal}** workout routine with ${numExercises} exercises *only* using this equipment, based on the user's selected muscle groups. The workout must be designed to fit a total duration of ${selectedDuration} minutes.

            For the JSON response:
            1. The 'setsReps' field MUST be formatted exactly as 'X sets of Y reps' (e.g., '3 sets of 8-12 reps').
            2. The 'restTime' field MUST be formatted exactly as 'X seconds' (e.g., '90 seconds'). Base the value on a typical rest time for a ${selectedGoal} workout (e.g., use '${preset.restTarget}').
            3. The 'focus' field MUST be formatted as 'Main Muscle Group (Specific Muscles Hit)' (e.g., 'Back (Lats, Rhomboids, Biceps)').
            4. The 'description' must be a concise (1-2 sentence) explanation of the movement.
            
            All advice must be safe and age-appropriate.`;
            
            const userQuery = `Generate a workout for the following muscle groups: ${selectedGroups.join(', ')}.`;

            // Define the JSON schema for the structured response 
            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        name: { type: "STRING" },
                        focus: { type: "STRING" },
                        setsReps: { type: "STRING" },
                        restTime: { type: "STRING" }, // New field for formatted rest time
                        description: { type: "STRING" },
                    },
                    required: ["name", "focus", "setsReps", "restTime", "description"]
                }
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };
            
            // Explicitly define the full API URL for correct runtime authentication
            const FULL_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            try {
                const response = await exponentialBackoffFetch(FULL_API_URL, options);

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorResult = await response.json();
                        errorMsg = errorResult.error?.message || errorMsg;
                    } catch (e) { /* non-JSON response */ }
                    throw new Error(`API Error: ${errorMsg}`);
                }
                
                const result = await response.json();
                
                loader.classList.add('hidden'); // Hide loader on success
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const exercises = JSON.parse(jsonText);
                    
                    // Initialize tips/fetching status for new roadmap feature
                    currentWorkout = exercises.map(ex => ({
                        ...ex,
                        tips: null,
                        isFetchingTips: false
                    }));


                    if (currentWorkout.length === 0) {
                         placeholder.innerHTML = `<p class="text-lg text-gray-400">No exercises found for this combination. Try selecting different muscle groups or generating again.</p>`;
                         placeholder.classList.remove('hidden');
                         return;
                    }

                    // Populate the initial list summary
                    currentWorkout.forEach((exercise, index) => {
                        list.innerHTML += createInitialListCard(exercise, index);
                    });
                    
                    // Add the START button
                    list.innerHTML += `
                        <button id="start-workout-btn" class="w-full mt-6 bg-purple-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-purple-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                            START WORKOUT (Roadmap View)
                        </button>
                    `;
                    document.getElementById('start-workout-btn').addEventListener('click', startWorkout);
                    
                    document.getElementById('workout-list').classList.remove('hidden');


                } else {
                    placeholder.innerHTML = `<p class="text-lg text-red-400">Sorry, I couldn't generate a workout right now. Please try again.</p>`;
                    placeholder.classList.remove('hidden');
                }

            } catch (error) {
                loader.classList.add('hidden'); // Hide loader on error
                placeholder.innerHTML = `<p class="text-lg text-red-400 font-semibold">An error occurred:</p><p class="text-md text-gray-400 mt-2">${error.message}</p>`;
                placeholder.classList.remove('hidden');
                console.error("Workout Generation Error:", error);
            }
        }

        // On page load, set up the new generator
        document.addEventListener('DOMContentLoaded', () => {
            
            // Populate muscle group checkboxes
            const selectorContainer = document.getElementById('muscle-group-selector');
            muscleGroups.forEach(group => {
                const id = group.toLowerCase().replace(' ', '-');
                selectorContainer.innerHTML += `
                    <label for="${id}" class="muscle-label cursor-pointer">
                        <input type="checkbox" id="${id}" value="${group}" class="sr-only">
                        <div class="text-center p-3 border-2 border-gray-700 bg-gray-700 text-gray-300 rounded-lg font-semibold hover:bg-gray-600">
                            ${group}
                        </div>
                    </label>
                `;
            });

            // --- Dynamic Duration Slider Listener ---
            const durationSlider = document.getElementById('workout-duration');
            const durationDisplay = document.getElementById('duration-display');
            durationSlider.addEventListener('input', () => {
                const minutes = durationSlider.value;
                let display = `${minutes} Minutes`;
                if (minutes == 120) {
                    display = '120 Minutes (2 Hours)';
                }
                durationDisplay.textContent = display;
            });
            // Set initial display
            durationDisplay.textContent = `${durationSlider.value} Minutes`;


            // Attach listener to the main generate button
            const generateButton = document.getElementById('generate-btn');
            generateButton.addEventListener('click', generateWorkout);
        });
    </script>
</body>
</html>
